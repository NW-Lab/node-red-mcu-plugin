<script type="text/javascript">
(function() {
    if (!RED.view.annotations) {
        RED.notify("Flow Debugger requires Node-RED 2.0.0-beta.2 or later");
        return;
    }
    var MAX_MESSAGE_LOADED = 10;
    var sidebarContent;
    var activeMessageFilter = 'all';

    var treeList;
    var objects = {};
    var missingParents = {};

    let flowData = [];
    let flowList = flowData;

    function show() {
        RED.sidebar.show("node-red-mcu");
    }

    function getFlowData() {
        var flowData = [
            {
                label: 'Flows',
                expanded: true,
                children: [],
                collapsible: false
            },/*
            {
                id: "__subflow__",
                label: "Subflows",
                expanded: true,
                children: [
                    getEmptyItem("__subflow__")
                ],
                collapsible: false
            },*/
        ]

        flowList = flowData[0];
        subflowList = flowData[1];
        globalConfigNodes = flowData[2];
        configNodeTypes = { __global__: globalConfigNodes};

        return flowData;
    }


    function onFlowAdd(ws) {
        objects[ws.id] = {
            id: ws.id,
            element: getFlowLabel(ws),
            // children:[],
            deferBuild: true,
            icon: "red-ui-icons red-ui-icons-flow",
            gutter: getGutter(ws),
            checkbox: true,
            selected: ws._mcu===true
        }
        /*
        if (missingParents[ws.id]) {
            objects[ws.id].children = missingParents[ws.id];
            delete missingParents[ws.id]
        } else {
            objects[ws.id].children.push(getEmptyItem(ws.id));
        }*/

        // console.log(ws);

        flowList.treeList.addChild(objects[ws.id])
        objects[ws.id].element.toggleClass("red-ui-info-outline-item-disabled", !!ws.disabled)
        objects[ws.id].treeList.container.toggleClass("red-ui-info-outline-item-disabled", !!ws.disabled)
        // updateSearch();

    }
    function onFlowChange(n) {
        var existingObject = objects[n.id];

        var label = n.label || n.id;
        var newlineIndex = label.indexOf("\\n");
        if (newlineIndex > -1) {
            label = label.substring(0,newlineIndex)+"...";
        }
        existingObject.element.find(".red-ui-info-outline-item-label").text(label);
        existingObject.element.toggleClass("red-ui-info-outline-item-disabled", !!n.disabled)
        existingObject.treeList.container.toggleClass("red-ui-info-outline-item-disabled", !!n.disabled)
        // updateSearch();
    }
    function onFlowsReorder(order) {
        var indexMap = {};
        order.forEach(function(id,index) {
            indexMap[id] = index;
        })

        flowList.treeList.sortChildren(function(A,B) {
            if (A.id === "__global__") { return -1 }
            if (B.id === "__global__") { return 1 }
            return indexMap[A.id] - indexMap[B.id]
        })
    }

    function getFlowLabel(n) {
        var div = $('<div>',{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"});
        var contentDiv = $('<div>',{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(div);
        var label = (typeof n === "string")? n : n.label;
        var newlineIndex = label.indexOf("\\n");
        if (newlineIndex > -1) {
            label = label.substring(0,newlineIndex)+"...";
        }
        contentDiv.text(label);
        addControls(n, div);
        return div;
    }

    function addControls(n,div) {
        var controls = $('<div>',{class:"red-ui-info-outline-item-controls red-ui-info-outline-item-hover-controls"}).appendTo(div);

        if (n.type === "subflow") {
            var subflowInstanceBadge = $('<button type="button" class="red-ui-info-outline-item-control-users red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').text(n.instances.length).appendTo(controls).on("click",function(evt) {
                evt.preventDefault();
                evt.stopPropagation();
                RED.search.show("type:subflow:"+n.id);
            })
            // RED.popover.tooltip(userCountBadge,function() { return RED._('editor.nodesUse',{count:n.users.length})});
        }
        if (n._def.category === "config" && n.type !== "group") {
            var userCountBadge = $('<button type="button" class="red-ui-info-outline-item-control-users red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').text(n.users.length).appendTo(controls).on("click",function(evt) {
                evt.preventDefault();
                evt.stopPropagation();
                RED.search.show("uses:"+n.id);
            })
            RED.popover.tooltip(userCountBadge,function() { return RED._('editor.nodesUse',{count:n.users.length})});
        }

        if (n._def.button) {
            var triggerButton = $('<button type="button" class="red-ui-info-outline-item-control-action red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').appendTo(controls).on("click",function(evt) {
                evt.preventDefault();
                evt.stopPropagation();
                RED.view.clickNodeButton(n);
            })
            RED.popover.tooltip(triggerButton,RED._("sidebar.info.triggerAction"));
        }

        if (n.type === "tab") {
            var toggleVisibleButton = $('<button type="button" class="red-ui-info-outline-item-control-hide red-ui-button red-ui-button-small"><i class="fa fa-eye"></i><i class="fa fa-eye-slash"></i></button>').appendTo(controls).on("click",function(evt) {
                evt.preventDefault();
                evt.stopPropagation();
                var isHidden = !div.hasClass("red-ui-info-outline-item-hidden");
                div.toggleClass("red-ui-info-outline-item-hidden",isHidden);
                if (isHidden) {
                    RED.workspaces.hide(n.id);
                } else {
                    RED.workspaces.show(n.id, null, true);
                }
            });
        }
        if (n.type !== 'subflow') {
            var toggleButton = $('<button type="button" class="red-ui-info-outline-item-control-disable red-ui-button red-ui-button-small"><i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i></button>').appendTo(controls).on("click",function(evt) {
                evt.preventDefault();
                evt.stopPropagation();
                if (n.type === 'tab') {
                    if (n.disabled) {
                        RED.workspaces.enable(n.id)
                    } else {
                        RED.workspaces.disable(n.id)
                    }
                } else if (n.type === 'group') {
                    var groupNodes = RED.group.getNodes(n,true);
                    var groupHistoryEvent = {
                        t:'multi',
                        events:[],
                        dirty: RED.nodes.dirty()
                    }
                    var targetState;
                    groupNodes.forEach(function(n) {
                        if (n.type !== 'group') {
                            if (targetState === undefined) {
                                targetState = !n.d;
                            }
                            var state = !!n.d;
                            if (state !== targetState) {
                                var historyEvent = {
                                    t: "edit",
                                    node: n,
                                    changed: n.changed,
                                    changes: {
                                        d: n.d
                                    }
                                }
                                if (n.d) {
                                    delete n.d;
                                } else {
                                    n.d = true;
                                }
                                n.dirty = true;
                                n.dirtyStatus = true;
                                n.changed = true;
                                RED.events.emit("nodes:change",n);
                                groupHistoryEvent.events.push(historyEvent);
                            }
                        }
                        if (groupHistoryEvent.events.length > 0) {
                            RED.history.push(groupHistoryEvent);
                            RED.nodes.dirty(true)
                            RED.view.redraw();
                        }
                    })
                } else {
                    // TODO: this ought to be a utility function in RED.nodes
                    var historyEvent = {
                        t: "edit",
                        node: n,
                        changed: n.changed,
                        changes: {
                            d: n.d
                        },
                        dirty:RED.nodes.dirty()
                    }
                    if (n.d) {
                        delete n.d;
                    } else {
                        n.d = true;
                    }
                    n.dirty = true;
                    n.dirtyStatus = true;
                    n.changed = true;
                    RED.events.emit("nodes:change",n);
                    RED.history.push(historyEvent);
                    RED.nodes.dirty(true)
                    RED.view.redraw();
                }
            });
            RED.popover.tooltip(toggleButton,function() {
                if (n.type === "group") {
                    return RED._("common.label.enable")+" / "+RED._("common.label.disable")
                }
                return RED._("common.label."+(((n.type==='tab' && n.disabled) || (n.type!=='tab' && n.d))?"enable":"disable"));
            });
        } else {
            $('<div class="red-ui-info-outline-item-control-spacer">').appendTo(controls)
        }
        controls.find("button").on("dblclick", function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
        })
    }

    function getGutter(n) {
        var span = $("<span>",{class:"red-ui-info-outline-gutter red-ui-treeList-gutter-float"});
        var revealButton = $('<button type="button" class="red-ui-info-outline-item-control-reveal red-ui-button red-ui-button-small"><i class="fa fa-search"></i></button>').appendTo(span).on("click",function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
            RED.view.reveal(n.id);
        })
        RED.popover.tooltip(revealButton,RED._("sidebar.info.find"));
        return span;
    }

    function onSubflowAdd(sf) {
        objects[sf.id] = {
            id: sf.id,
            element: getNodeLabel(sf),
            // children:[],
            deferBuild: true,
            gutter: getGutter(sf),
            checkbox: true
        }
        /*
        if (missingParents[sf.id]) {
            objects[sf.id].children = missingParents[sf.id];
            delete missingParents[sf.id]
        } else {
            objects[sf.id].children.push(getEmptyItem(sf.id));
        }*/
        if (empties["__subflow__"]) {
            empties["__subflow__"].treeList.remove();
            delete empties["__subflow__"];
        }
        subflowList.treeList.addChild(objects[sf.id])
        // updateSearch();
    }
    function onSubflowChange(sf) {
        var existingObject = objects[sf.id];
        existingObject.treeList.replaceElement(getNodeLabel(sf));
        // existingObject.element.find(".red-ui-info-outline-item-label").text(n.name || n.id);
        RED.nodes.eachNode(function(n) {
            if (n.type == "subflow:"+sf.id) {
                var sfInstance = objects[n.id];
                sfInstance.treeList.replaceElement(getNodeLabel(n));
            }
        });
        // updateSearch();
    }

    var empties = {};
    function getEmptyItem(id) {
        var item = {
            empty: true,
            element: $('<div class="red-ui-info-outline-item red-ui-info-outline-item-empty">').text(RED._("sidebar.info.empty")),
        }
        empties[id] = item;
        return item;
    }

    function getNodeLabel(n) {
        var div = $('<div>',{class:"red-ui-node-list-item red-ui-info-outline-item"});
        RED.utils.createNodeIcon(n, true).appendTo(div);
        div.find(".red-ui-node-label").addClass("red-ui-info-outline-item-label")
        addControls(n, div);
        return div;
    }

    function onObjectRemove(n) {
        var existingObject = objects[n.id];
        existingObject.treeList.remove();
        delete objects[n.id]

        if (/^subflow:/.test(n.type)) {
            var sfType = n.type.substring(8);
            if (objects[sfType]) {
                objects[sfType].element.find(".red-ui-info-outline-item-control-users").text(RED.nodes.subflow(sfType).instances.length);
            }
        }

        // If this is a group being removed, it may have an empty item
        if (empties[n.id]) {
            delete empties[n.id];
        }
        var parent = existingObject.parent;
        if (parent.children.length === 0) {
            if (parent.config) {
                // this is a config
                parent.treeList.remove();
                delete configNodeTypes[parent.parent.id||n.z].types[n.type];
                if (parent.parent.children.length === 0) {
                    if (parent.parent.id === "__global__") {
                        parent.parent.treeList.addChild(getEmptyItem(parent.parent.id));
                    } else {
                        delete configNodeTypes[n.z];
                        parent.parent.treeList.remove();
                        if (parent.parent.parent.children.length === 0) {
                            parent.parent.parent.treeList.addChild(getEmptyItem(parent.parent.parent.id));
                        }
                    }
                }
            } else {
                parent.treeList.addChild(getEmptyItem(parent.id));
            }
        }
    }


    // RED.events.on("projects:load", onProjectLoad)

    
    RED.events.on("flows:add", onFlowAdd)
    RED.events.on("flows:remove", onObjectRemove)
    RED.events.on("flows:change", onFlowChange)
    RED.events.on("flows:reorder", onFlowsReorder)
/*
    RED.events.on("subflows:add", onSubflowAdd)
    RED.events.on("subflows:remove", onObjectRemove)
    RED.events.on("subflows:change", onSubflowChange)
*/

    RED.plugins.registerPlugin("node-red-mcu", {
        onadd: function() {

            let flows2build = [];

            function patch_node_type_for_mcu(nt) {
                let t = RED.nodes.getType(nt);
                t.defaults["_mcu"] = {value: false}
                t = RED.nodes.getType(nt);            
                if (!t.defaults._mcu) {
                    console.log("MCU: Failed to patch type '" + nt + "'.")
                }
            }

            // Patch mcu flag into the defaults of any type
            // This is a prerequisite as the NR editor only forwards properties to the runtime,
            // that are defined in the defaults.
            RED.events.on("registry:node-type-added", function(nt) {
                patch_node_type_for_mcu(nt);
            });

            // Same for the flow...
            patch_node_type_for_mcu("tab");

            sidebarContent = $("<div>").addClass("red-ui-flow-debugger disabled").css({"position":"relative","height":"100%"});
            var container = $("<div>", {class:"red-ui-info-outline"}).css({'height': '100%'}).appendTo(sidebarContent);

            var footerToolbar = $('<div></div>');

            // var container = $("<div>", {class:"red-ui-info-outline"}).css({'height': '100%'});
            var toolbar = $("<div>", {class:"red-ui-sidebar-header"}).appendTo(container);

            $("<span>").text("MCU Build Configuration").css({width: "100%", "text-align": "left", "font-weight": "bold"}).appendTo(toolbar);

            let selectedFlowList = $("<div>").css({width: "100%"}).appendTo(container).treeList({
                data:getFlowData(),
                multi: true,
            }).on('treelistselect', function(event, item) {

                let selected = selectedFlowList.treeList("selected")

                let f2b = [];
                for (let ii=0; ii<selected.length; ii+=1) {
                    let s = selected[ii];
                    f2b.push(s.id);
                }

                // TODO: This should be UNDOable!
                let changed = false;
                let f2bl = f2b.length;

                RED.nodes.eachWorkspace(function(ws) {

                    // c === 3: node has flag but need none; remove it
                    // c === 2: node got mcu flag
                    // c === 1: node already has flag
                    // c === 0: node has no flag nor needs one
                    let c = 0;

                    for (let i=0; i<f2bl; i+=1) {
                        // mark the flow
                        if (ws.id && ws.id===f2b[i]) {
                            if (ws._mcu===true) {
                                c = 1;
                            } else {
                                c = 2;
                            }
                            break;
                        }

                    }

                    if (c>0) {
                        ws._mcu = true;
                    }
                    if (c<1) {
                        delete ws._mcu;
                        c = 3;
                    } 
                    if (c>1) {
                        ws.changed = true;
                        RED.events.emit("flows:change",ws);
                        changed = true;
                    }
                })

                RED.nodes.eachNode(function(node){
                    
                    // c === 3: node has flag but need none; remove it
                    // c === 2: node got mcu flag
                    // c === 1: node already has flag
                    // c === 0: node has no flag nor needs one
                    let c = 0;

                    for (let i=0; i<f2bl; i+=1) {

                        // mark the nodes
                        if (node.z && node.z===f2b[i]) {
                            if (node._mcu===true) {
                                c = 1;
                            } else {
                                c = 2;
                            }
                            break;
                        }
                    }

                    if (c>0) {
                        node._mcu = true;
                    }
                    if (c<1) {
                        delete node._mcu;
                        c = 3;
                    } 
                    if (c>1) {
                        node.changed = true;
                        RED.events.emit("nodes:change",node);
                        changed = true;
                    }
                })

                if (changed) {
                    RED.nodes.dirty(true);
                    RED.view.updateActive();
                    RED.view.redraw(true);
                }

                flows2build = f2b;

                // still necessary???
                $.ajax({
                    url: "mcu/flows2build",
                    contentType: "application/json",
                    type:"POST",
                    data:JSON.stringify({"flows2build": flows2build}),
                    success: function(resp) {
                        // buildButton.toggleClass("disabled",!debuggerEnabled);
                        console.log("success");
                        // $(buildButton).trigger("change");
                    },
                    error: function(jqXHR,textStatus,errorThrown) {
                        console.log(jqXHR,textStatus,errorThrown);
                        // $(buildButton).trigger("change");
                    }
                });
            });

        var header = $("<div>", {class:"red-ui-sidebar-header"}).appendTo(container);

var headerLeftSpan = $('<span>').css({"flex-grow":1,"text-align":"left"}).appendTo(header);
var headerRightSpan = $('<span>').css({"display":"unset"}).appendTo(header);
//var headerPlayControl = $('<span>',{class:"button-group"}).appendTo(headerRightSpan);
//var headerStepControl = $('<span>',{class:"button-group"}).appendTo(headerRightSpan);

        // toolbar = $("<div>", {class:"red-ui-sidebar-header"}).appendTo(container);
        $("<span>").css({height: "100%", "vertical-align": "middle", display: "inline-block"}).appendTo(headerLeftSpan); 
        $("<span>").text("MCU Build Setup").css({width: "100%", "text-align": "left", "font-weight": "bold", "vertical-align": "middle", display: "inline-block"}).appendTo(headerLeftSpan);

        var buildButton = $('<input type="checkbox"/>').appendTo(headerRightSpan).toggleButton({
            enabledIcon: "fa-gear fa-spin fa-fw",
            disabledIcon: "fa-cog",
            // baseClass: "red-ui-sidebar-header-button"
            enabledLabel: "Build",
            disabledLabel: "Build"
        }).on("change", function() {
            if ($(buildButton).prop("checked") === true) {
                console.log("clicking")
                $(buildButton).prop("checked", false);
                $.ajax({
                    url: "mcu/build",
                    contentType: "application/json",
                    type:"PUT",
                    success: function(resp) {
                        // buildButton.toggleClass("disabled",!debuggerEnabled);
                        console.log("success");
                        $(buildButton).trigger("change");
                    },
                    error: function(jqXHR,textStatus,errorThrown) {
                        console.log(jqXHR,textStatus,errorThrown);
                        $(buildButton).trigger("change");
                    }
                });                
            }
        });

        var table = $('<table class="red-ui-info-table"></table>').appendTo(container);
        var tableBody = $('<tbody>').appendTo(table);

        /*
        var tableRow = $('<tr class="red-ui-help-info-row">').appendTo(tableBody);
        $('<td>Path to "flows.js"</td>').css({width: "150px"}).appendTo(tableRow);
        let inputcell = $('<td>').appendTo(tableRow);
        $('<input>').css({width: "calc(100% - 6px)", border: "none"}).appendTo(inputcell);

        tableRow = $('<tr class="red-ui-help-info-row">').appendTo(tableBody);
        $('<td>Build command</td>').css({width: "150px"}).appendTo(tableRow);
        $('<td>').appendTo(tableRow);

        tableRow = $('<tr class="red-ui-help-info-row">').appendTo(tableBody);
        $('<td>Build on deploy</td>').css({width: "150px"}).appendTo(tableRow);
        $('<td>').text("true").appendTo(tableRow);
        

        var settings = $("<div>", {class:"red-ui-sidebar-header"}).appendTo(container);
        $("<span>").text("This setup is defined in your settings.js.").css({width: "100%", "text-align": "center"}).appendTo(settings);
        */
            // var settings = $("<div>").text("This setup is defined in your settings.js.").appendTo(container);
        // $("<div>").text("MCU Build Setup").css({width: "100%", "text-align": "left"}).appendTo(settings);
        //$("<div>").text("compiler path: test.js").css({width: "100%", "text-align": "left"}).appendTo(settings);
        
            RED.sidebar.addTab({
                id: "node-red-mcu",
                label: "MCU",
                name: "Node-Red for microcontrollers",
                iconClass: "fa fa-microchip",
                content: sidebarContent,
                // toolbar: footerToolbar,
                enableOnEdit: true,
                // action: "core:show-flow-debugger-tab"
            });

        }

    })
})();
</script>